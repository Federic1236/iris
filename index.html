<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA IRIS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: black;
            font-family: 'Arial Black', sans-serif;
        }

        /* Video a tutto schermo */
        #bg-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            z-index: -1;
            object-fit: cover;
        }

        #bouncing-text {
            position: absolute;
            font-size: 6vw;
            color: white;
            text-shadow: 0 0 20px rgba(0,0,0,0.8);
            white-space: nowrap;
            user-select: none;
            will-change: transform;
            z-index: 10;
        }

        #overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            z-index: 1000;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>SISTEMA IRIS</h1>
        <p>iris per sempre</p>
    </div>

    <video id="bg-video" loop muted playsinline>
        <source id="video-source" src="background.mp4" type="video/mp4">
        iris Ã¨ caduta
    </video>

    <div id="bouncing-text">IRIS</div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const textElement = document.getElementById('bouncing-text');
        const overlay = document.getElementById('overlay');
        const video = document.getElementById('bg-video');
        const videoSource = document.getElementById('video-source');
        
        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
            databaseURL: "https://iriscontrol-a207a-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- AUDIO & LOGICA ---
        const AUDIO_FILE = 'music.mp3'; 
        let audioCtx, x = 0, y = 0, dx = 6, dy = 6;
        let isLiveText = false;

        async function init() {
            video.play();
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            try {
                const response = await fetch(AUDIO_FILE);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                source.loop = true;

                const delay = audioCtx.createDelay();
                delay.delayTime.value = 0.4;
                const feedback = audioCtx.createGain();
                feedback.gain.value = 0.4;
                const reverb = audioCtx.createConvolver();
                reverb.buffer = createReverbBuffer(2.0);

                source.connect(reverb);
                reverb.connect(delay);
                delay.connect(feedback);
                feedback.connect(delay);
                
                source.connect(audioCtx.destination);
                delay.connect(audioCtx.destination);
                reverb.connect(audioCtx.destination);

                source.start();
                
                // ASCOLTA COMANDI LIVE DA FIREBASE
                setupFirebaseListeners();
                
                animate();
            } catch (e) {
                console.error("Errore Audio:", e);
                animate();
            }
        }

        function setupFirebaseListeners() {
            // Ascolta cambio Video
            database.ref('currentVideo').on('value', (snapshot) => {
                const newVideo = snapshot.val();
                if (newVideo) {
                    videoSource.src = newVideo;
                    video.load();
                    video.play();
                }
            });

            // Ascolta cambio Testo
            database.ref('currentText').on('value', (snapshot) => {
                const newText = snapshot.val();
                if (newText) {
                    textElement.textContent = newText;
                    isLiveText = true; // Ferma il cambio automatico se l'admin scrive
                }
            });
        }

        function createReverbBuffer(seconds) {
            const len = audioCtx.sampleRate * seconds;
            const buf = audioCtx.createBuffer(2, len, audioCtx.sampleRate);
            for (let i = 0; i < 2; i++) {
                let chan = buf.getChannelData(i);
                for (let j = 0; j < len; j++) {
                    chan[j] = (Math.random() * 2 - 1) * Math.pow(1 - j / len, 2);
                }
            }
            return buf;
        }

        function animate() {
            const maxX = window.innerWidth - textElement.offsetWidth;
            const maxY = window.innerHeight - textElement.offsetHeight;
            x += dx; y += dy;
            if (x >= maxX || x <= 0) dx *= -1;
            if (y >= maxY || y <= 0) dy *= -1;
            textElement.style.transform = `translate(${x}px, ${y}px)`;
            requestAnimationFrame(animate);
        }

        overlay.addEventListener('click', () => {
            overlay.style.display = 'none';
            init();
        });
    </script>
</body>
</html>
